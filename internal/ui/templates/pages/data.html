{{define "content"}}
<div class="data-page">
    <section class="page-header">
        <div class="page-header-actions">
        </div>
    </section>

    <div class="data-grid">
        <section class="card">
            <div class="card-header">
                <h3>Export Data</h3>
            </div>
            <div class="card-body">
                <div class="export-section">
                    <div class="export-group">
                        <h4>Assets (Deposits/Withdrawals)</h4>
                        <p class="export-desc">Export all your asset transactions</p>
                        <div class="export-buttons">
                            <a href="/api/assets/export?format=csv" class="btn btn-secondary" download>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="7 10 12 15 17 10"/>
                                    <line x1="12" y1="15" x2="12" y2="3"/>
                                </svg>
                                CSV
                            </a>
                            <a href="/api/assets/export?format=json" class="btn btn-secondary" download>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="7 10 12 15 17 10"/>
                                    <line x1="12" y1="15" x2="12" y2="3"/>
                                </svg>
                                JSON
                            </a>
                        </div>
                    </div>
                    <div class="export-group">
                        <h4>Exchanges</h4>
                        <p class="export-desc">Export all your exchange transactions</p>
                        <div class="export-buttons">
                            <a href="/api/exchanges/export?format=csv" class="btn btn-secondary" download>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="7 10 12 15 17 10"/>
                                    <line x1="12" y1="15" x2="12" y2="3"/>
                                </svg>
                                CSV
                            </a>
                            <a href="/api/exchanges/export?format=json" class="btn btn-secondary" download>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="7 10 12 15 17 10"/>
                                    <line x1="12" y1="15" x2="12" y2="3"/>
                                </svg>
                                JSON
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h3>Import Data</h3>
                <button class="btn btn-icon" @click="$dispatch('open-sample-modal')" title="View sample format">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                </button>
            </div>
            <div class="card-body">
                <div x-data="importForm()">
                    <form @submit.prevent="submitImport()" class="import-form">
                        <div class="form-group">
                            <label>Format</label>
                            <select x-model="format" class="form-control">
                                <option value="csv">CSV (semicolon-delimited)</option>
                                <option value="json">JSON</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>File</label>
                            <input type="file" @change="handleFile($event)" class="form-control" :accept="format === 'csv' ? '.csv' : '.json'" required>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary" :disabled="!file || importing">
                                <svg x-show="importing" class="spinner" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                                </svg>
                                <span x-text="importing ? 'Importing...' : 'Import Assets'"></span>
                            </button>
                        </div>
                    </form>

                    <div x-show="result" x-cloak class="import-result" :class="result?.status">
                        <div class="result-header">
                            <span class="result-status" x-text="result?.status === 'completed' ? 'Import Complete' : result?.status === 'partial' ? 'Partial Import' : 'Import Failed'"></span>
                        </div>
                        <div class="result-stats">
                            <span class="stat success"><strong x-text="result?.imported"></strong> imported</span>
                            <span class="stat error" x-show="result?.failed > 0"><strong x-text="result?.failed"></strong> failed</span>
                        </div>
                        <div x-show="result?.errors?.length > 0" class="result-errors">
                            <h4>Errors:</h4>
                            <ul>
                                <template x-for="err in result?.errors" :key="err.row">
                                    <li>
                                        <strong>Row <span x-text="err.row"></span>:</strong>
                                        <span x-text="err.message"></span>
                                    </li>
                                </template>
                            </ul>
                            <button @click="openFixModal()" class="btn btn-secondary btn-sm">Fix & Retry</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <section class="card import-history-section">
        <div class="card-header">
            <h3>Import History</h3>
        </div>
        <div class="card-body">
            <div id="import-history-container" hx-get="/partials/data/import-history" hx-trigger="load" hx-swap="innerHTML">
                <div class="skeleton-table">
                    <div class="skeleton-row"><div class="skeleton text"></div><div class="skeleton text"></div><div class="skeleton text"></div></div>
                </div>
            </div>
        </div>
    </section>

    <div x-data="fixModal()" @open-fix-modal.window="open($event.detail)">
        <div x-show="isOpen" x-cloak class="modal-overlay" @click.self="isOpen = false" @keydown.escape.window="isOpen = false">
            <div class="modal modal-lg" x-transition>
                <div class="modal-header">
                    <h2 class="modal-title">Fix & Retry Import</h2>
                    <button @click="isOpen = false" class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <p class="modal-desc">Edit the failed rows below and retry the import.</p>
                    <div class="fix-rows">
                        <template x-for="(row, index) in rows" :key="index">
                            <div class="fix-row">
                                <div class="fix-row-header">
                                    <span class="row-num">Row <span x-text="row.originalRow"></span></span>
                                    <span class="row-error" x-text="row.error"></span>
                                </div>
                                <div class="fix-row-fields">
                                    <div class="form-group">
                                        <label>Symbol</label>
                                        <input type="text" x-model="row.data.symbol" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label>Amount</label>
                                        <input type="number" step="any" x-model="row.data.amount" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label>Type</label>
                                        <select x-model="row.data.transaction_type" class="form-control">
                                            <option value="deposit">Deposit</option>
                                            <option value="withdrawal">Withdrawal</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Timestamp</label>
                                        <input type="datetime-local" x-model="row.data.timestamp" class="form-control">
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                <div class="modal-footer">
                    <button @click="isOpen = false" class="btn btn-secondary">Cancel</button>
                    <button @click="retry()" class="btn btn-primary" :disabled="retrying">
                        <span x-text="retrying ? 'Retrying...' : 'Retry Import'"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div x-data="deleteConfirmModal()" @open-delete-import-modal.window="openModal($event.detail)">
        <div x-show="isOpen" x-cloak class="modal-overlay" @click.self="isOpen = false" @keydown.escape.window="isOpen = false">
            <div class="modal modal-sm" x-transition>
                <div class="modal-header">
                    <h2 class="modal-title">Delete Import Log</h2>
                    <button @click="isOpen = false" class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this import log?</p>
                    <label class="checkbox-label">
                        <input type="checkbox" x-model="dontAskAgain">
                        <span>Don't ask again</span>
                    </label>
                </div>
                <div class="modal-footer">
                    <button @click="isOpen = false" class="btn btn-secondary">Cancel</button>
                    <button @click="confirmDelete()" class="btn btn-danger">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <div x-data="{ isOpen: false, tab: 'csv' }" @open-sample-modal.window="isOpen = true">
        <div x-show="isOpen" x-cloak class="modal-overlay" @click.self="isOpen = false" @keydown.escape.window="isOpen = false">
            <div class="modal modal-lg" x-transition>
                <div class="modal-header">
                    <h2 class="modal-title">Import File Format</h2>
                    <button @click="isOpen = false" class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="sample-tabs">
                        <div class="tab-buttons">
                            <button @click="tab = 'csv'" :class="{ active: tab === 'csv' }" class="tab-btn">CSV</button>
                            <button @click="tab = 'json'" :class="{ active: tab === 'json' }" class="tab-btn">JSON</button>
                        </div>
                        <div x-show="tab === 'csv'" class="sample-content">
                            <p class="sample-desc">CSV files must use <strong>semicolon (;)</strong> as delimiter with the following columns:</p>
                            <pre class="sample-code">symbol;name;amount;transaction_type;timestamp;notes
BTC;Bitcoin;0.5;deposit;2024-01-15T10:30:00Z;Initial purchase
ETH;Ethereum;2.0;deposit;2024-01-16T14:00:00Z;From exchange
BTC;Bitcoin;0.1;withdrawal;2024-01-20T09:15:00Z;To hardware wallet</pre>
                        </div>
                        <div x-show="tab === 'json'" class="sample-content">
                            <p class="sample-desc">JSON files must be an array of asset objects:</p>
                            <pre class="sample-code">[
  {
    "symbol": "BTC",
    "name": "Bitcoin",
    "amount": 0.5,
    "transaction_type": "deposit",
    "timestamp": "2024-01-15T10:30:00Z",
    "notes": "Initial purchase"
  },
  {
    "symbol": "ETH",
    "name": "Ethereum",
    "amount": 2.0,
    "transaction_type": "deposit",
    "timestamp": "2024-01-16T14:00:00Z",
    "notes": "From exchange"
  }
]</pre>
                        </div>
                    </div>
                    <div class="sample-fields">
                        <h4>Field Reference</h4>
                        <table class="fields-table">
                            <thead>
                                <tr><th>Field</th><th>Required</th><th>Description</th></tr>
                            </thead>
                            <tbody>
                                <tr><td><code>symbol</code></td><td>Yes</td><td>Cryptocurrency symbol (e.g., BTC, ETH)</td></tr>
                                <tr><td><code>name</code></td><td>No</td><td>Full name of the cryptocurrency</td></tr>
                                <tr><td><code>amount</code></td><td>Yes</td><td>Positive number representing quantity</td></tr>
                                <tr><td><code>transaction_type</code></td><td>Yes</td><td>Either "deposit" or "withdrawal"</td></tr>
                                <tr><td><code>timestamp</code></td><td>No</td><td>ISO 8601 format (defaults to now)</td></tr>
                                <tr><td><code>notes</code></td><td>No</td><td>Optional description</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button @click="isOpen = false" class="btn btn-secondary">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function importForm() {
    return {
        format: 'csv',
        file: null,
        importing: false,
        result: null,

        handleFile(event) {
            this.file = event.target.files[0];
            this.result = null;
        },

        async submitImport() {
            if (!this.file) return;
            this.importing = true;
            this.result = null;

            const formData = new FormData();
            formData.append('file', this.file);

            try {
                const response = await fetch(`/api/assets/import?format=${this.format}`, {
                    method: 'POST',
                    body: formData
                });
                this.result = await response.json();
                htmx.ajax('GET', '/partials/data/import-history', { target: '#import-history-container', swap: 'innerHTML' });
            } catch (e) {
                this.result = { status: 'failed', imported: 0, failed: 1, errors: [{ row: 0, message: 'Failed to process import' }] };
            } finally {
                this.importing = false;
            }
        },

        openFixModal() {
            if (this.result?.errors?.length > 0) {
                const rows = this.result.errors.map(err => ({
                    originalRow: err.row,
                    error: err.message,
                    data: typeof err.data === 'string' ? JSON.parse(err.data) : err.data || {}
                }));
                window.dispatchEvent(new CustomEvent('open-fix-modal', { detail: { importId: this.result.id, rows } }));
            }
        }
    }
}

function deleteImportLog(id) {
    const skipConfirm = localStorage.getItem('skipDeleteImportConfirm') === 'true';
    if (skipConfirm) {
        performDeleteImportLog(id);
    } else {
        window.dispatchEvent(new CustomEvent('open-delete-import-modal', { detail: { id } }));
    }
}

async function performDeleteImportLog(id) {
    try {
        const response = await fetch(`/api/imports/${id}`, { method: 'DELETE' });
        if (response.ok) {
            htmx.ajax('GET', '/partials/data/import-history', { target: '#import-history-container', swap: 'innerHTML' });
            window.dispatchEvent(new CustomEvent('show-toast', { detail: { message: 'Import log deleted', type: 'success' } }));
        } else {
            window.dispatchEvent(new CustomEvent('show-toast', { detail: { message: 'Failed to delete import log', type: 'error' } }));
        }
    } catch (e) {
        window.dispatchEvent(new CustomEvent('show-toast', { detail: { message: 'Failed to delete import log', type: 'error' } }));
    }
}

function deleteConfirmModal() {
    return {
        isOpen: false,
        deleteId: null,
        dontAskAgain: false,

        openModal(detail) {
            this.deleteId = detail.id;
            this.dontAskAgain = false;
            this.isOpen = true;
        },

        confirmDelete() {
            if (this.dontAskAgain) {
                localStorage.setItem('skipDeleteImportConfirm', 'true');
            }
            this.isOpen = false;
            performDeleteImportLog(this.deleteId);
        }
    }
}

function fixModal() {
    return {
        isOpen: false,
        importId: null,
        rows: [],
        retrying: false,

        open(detail) {
            this.importId = detail.importId;
            this.rows = detail.rows;
            this.isOpen = true;
        },

        async retry() {
            this.retrying = true;
            const assets = this.rows.map(r => ({
                symbol: r.data.symbol,
                name: r.data.name || '',
                amount: parseFloat(r.data.amount) || 0,
                transaction_type: r.data.transaction_type,
                timestamp: r.data.timestamp ? new Date(r.data.timestamp).toISOString() : new Date().toISOString(),
                notes: r.data.notes || ''
            }));

            try {
                const response = await fetch(`/api/imports/${this.importId}/retry`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(assets)
                });
                const result = await response.json();

                if (result.errors?.length > 0) {
                    this.rows = result.errors.map(err => ({
                        originalRow: err.row,
                        error: err.message,
                        data: typeof err.data === 'string' ? JSON.parse(err.data) : err.data || {}
                    }));
                    window.dispatchEvent(new CustomEvent('show-toast', { detail: { message: `${result.imported} imported, ${result.failed} still failing`, type: 'warning' } }));
                } else {
                    this.isOpen = false;
                    window.dispatchEvent(new CustomEvent('show-toast', { detail: { message: 'All rows imported successfully', type: 'success' } }));
                }
                htmx.ajax('GET', '/partials/data/import-history', { target: '#import-history-container', swap: 'innerHTML' });
            } catch (e) {
                window.dispatchEvent(new CustomEvent('show-toast', { detail: { message: 'Retry failed', type: 'error' } }));
            } finally {
                this.retrying = false;
            }
        }
    }
}
</script>

<style>
.data-page {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.data-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}

@media (max-width: 900px) {
    .data-grid {
        grid-template-columns: 1fr;
    }
}

.export-section {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.export-group h4 {
    margin: 0 0 0.25rem 0;
    font-size: 0.95rem;
}

.export-desc {
    margin: 0 0 0.75rem 0;
    color: var(--text-muted);
    font-size: 0.85rem;
}

.export-buttons {
    display: flex;
    gap: 0.5rem;
}

.import-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.import-result {
    margin-top: 1rem;
    padding: 1rem;
    border-radius: 8px;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
}

.import-result.completed {
    border-color: var(--success);
    background: rgba(16, 185, 129, 0.1);
}

.import-result.partial {
    border-color: var(--warning);
    background: rgba(245, 158, 11, 0.1);
}

.import-result.failed {
    border-color: var(--danger);
    background: rgba(239, 68, 68, 0.1);
}

.result-header {
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.result-stats {
    display: flex;
    gap: 1rem;
    margin-bottom: 0.5rem;
}

.result-stats .stat.success {
    color: var(--success);
}

.result-stats .stat.error {
    color: var(--danger);
}

.result-errors {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
}

.result-errors h4 {
    margin: 0 0 0.5rem 0;
    font-size: 0.9rem;
}

.result-errors ul {
    margin: 0 0 1rem 0;
    padding-left: 1.25rem;
    font-size: 0.85rem;
}

.result-errors li {
    margin-bottom: 0.25rem;
}

.import-history-section {
    margin-top: 0.5rem;
}

.fix-rows {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    max-height: 400px;
    overflow-y: auto;
}

.fix-row {
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: 8px;
}

.fix-row-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.75rem;
}

.row-num {
    font-weight: 600;
}

.row-error {
    color: var(--danger);
    font-size: 0.85rem;
}

.fix-row-fields {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
}

@media (max-width: 600px) {
    .fix-row-fields {
        grid-template-columns: 1fr;
    }
}

.modal-desc {
    margin-bottom: 1rem;
    color: var(--text-muted);
}

.spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.sample-tabs {
    margin-bottom: 1.5rem;
}

.tab-buttons {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.tab-btn {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: var(--bg-secondary);
    cursor: pointer;
    font-size: 0.875rem;
}

.tab-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.sample-desc {
    margin: 0 0 0.75rem 0;
    color: var(--text-muted);
    font-size: 0.875rem;
}

.sample-code {
    background: var(--bg-secondary);
    padding: 1rem;
    border-radius: 8px;
    overflow-x: auto;
    font-size: 0.8rem;
    line-height: 1.5;
    margin: 0;
}

.sample-fields {
    border-top: 1px solid var(--border-color);
    padding-top: 1rem;
}

.sample-fields h4 {
    margin: 0 0 0.75rem 0;
    font-size: 0.95rem;
}

.fields-table {
    width: 100%;
    font-size: 0.85rem;
    border-collapse: collapse;
}

.fields-table th,
.fields-table td {
    padding: 0.5rem;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

.fields-table th {
    font-weight: 600;
    background: var(--bg-secondary);
}

.fields-table code {
    background: var(--bg-secondary);
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
    font-size: 0.8rem;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1rem;
    cursor: pointer;
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.checkbox-label input[type="checkbox"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
    accent-color: var(--accent-primary);
}
</style>
{{end}}
