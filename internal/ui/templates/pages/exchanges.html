{{define "content"}}
<div class="exchanges-page">
    <section class="page-header">
        <div class="page-header-content">
            <h2>Exchanges</h2>
            <p class="text-muted">Record asset-to-asset exchanges and swaps.</p>
        </div>
        <div class="page-header-actions">
            <button class="btn btn-primary" @click="$dispatch('open-add-exchange')">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"/>
                </svg>
                Add Exchange
            </button>
        </div>
    </section>

    <section class="exchanges-filters">
        <div class="card">
            <div class="card-body filters-row">
                <div class="filter-group">
                    <label>From Asset</label>
                    <select name="from_asset_id" class="form-control"
                        hx-get="/partials/exchanges/table"
                        hx-target="#exchanges-table-container"
                        hx-include=".filters-row select, .filters-row input">
                        <option value="">All Assets</option>
                        {{range .Assets}}
                        <option value="{{.ID}}">{{.Symbol}}</option>
                        {{end}}
                    </select>
                </div>
                <div class="filter-group">
                    <label>To Asset</label>
                    <select name="to_asset_id" class="form-control"
                        hx-get="/partials/exchanges/table"
                        hx-target="#exchanges-table-container"
                        hx-include=".filters-row select, .filters-row input">
                        <option value="">All Assets</option>
                        {{range .Assets}}
                        <option value="{{.ID}}">{{.Symbol}}</option>
                        {{end}}
                    </select>
                </div>
                <div class="filter-group">
                    <label>From</label>
                    <input type="date" name="from" class="form-control"
                        hx-get="/partials/exchanges/table"
                        hx-target="#exchanges-table-container"
                        hx-trigger="change"
                        hx-include=".filters-row select, .filters-row input">
                </div>
                <div class="filter-group">
                    <label>To</label>
                    <input type="date" name="to" class="form-control"
                        hx-get="/partials/exchanges/table"
                        hx-target="#exchanges-table-container"
                        hx-trigger="change"
                        hx-include=".filters-row select, .filters-row input">
                </div>
            </div>
        </div>
    </section>

    <section class="exchanges-list">
        <div class="card">
            <div class="card-body">
                <div id="exchanges-table-container" hx-get="/partials/exchanges/table" hx-trigger="load" hx-swap="innerHTML">
                    <div class="skeleton-table">
                        <div class="skeleton-row"><div class="skeleton text"></div><div class="skeleton text"></div><div class="skeleton text"></div><div class="skeleton text"></div></div>
                        <div class="skeleton-row"><div class="skeleton text"></div><div class="skeleton text"></div><div class="skeleton text"></div><div class="skeleton text"></div></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div x-data="exchangeModal()" @open-add-exchange.window="openAdd()" @open-edit-exchange.window="openEdit($event.detail)" @close-modal.window="open = false">
        <div x-show="open" x-cloak class="modal-overlay" @click.self="open = false" @keydown.escape.window="open = false">
            <div class="modal modal-lg" x-transition>
                <div class="modal-header">
                    <h2 class="modal-title" x-text="isEdit ? 'Edit Exchange' : 'Add Exchange'"></h2>
                    <button @click="open = false" class="modal-close">&times;</button>
                </div>
                <form :hx-post="isEdit ? '/partials/exchanges/update/' + exchangeId : '/partials/exchanges/create'"
                      hx-target="#exchanges-table-container"
                      hx-swap="innerHTML"
                      @htmx:after-request="if(event.detail.successful) { open = false; $dispatch('show-toast', {message: isEdit ? 'Exchange updated' : 'Exchange added', type: 'success'}) }">
                    <div class="modal-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="ex-from-asset">From Asset <span class="required">*</span></label>
                                <select id="ex-from-asset" name="from_asset_id" class="form-control" required x-model="fromAssetId">
                                    <option value="">Select asset...</option>
                                    {{range .Assets}}
                                    <option value="{{.ID}}">{{.Symbol}} - {{.Name}}</option>
                                    {{end}}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="ex-from-amount">Amount <span class="required">*</span></label>
                                <input type="number" id="ex-from-amount" name="from_amount" class="form-control"
                                    step="any" min="0" required x-model="fromAmount" placeholder="0.00">
                            </div>
                        </div>
                        <div class="exchange-arrow">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M7 16V4m0 0L3 8m4-4l4 4M17 8v12m0 0l4-4m-4 4l-4-4"/>
                            </svg>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="ex-to-asset">To Asset <span class="required">*</span></label>
                                <select id="ex-to-asset" name="to_asset_id" class="form-control" required x-model="toAssetId">
                                    <option value="">Select asset...</option>
                                    {{range .Assets}}
                                    <option value="{{.ID}}">{{.Symbol}} - {{.Name}}</option>
                                    {{end}}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="ex-to-amount">Amount <span class="required">*</span></label>
                                <input type="number" id="ex-to-amount" name="to_amount" class="form-control"
                                    step="any" min="0" required x-model="toAmount" placeholder="0.00">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="ex-fee">Fee</label>
                                <input type="number" id="ex-fee" name="fee" class="form-control"
                                    step="any" min="0" x-model="fee" placeholder="0.00">
                            </div>
                            <div class="form-group">
                                <label for="ex-fee-currency">Fee Currency</label>
                                <input type="text" id="ex-fee-currency" name="fee_currency" class="form-control"
                                    x-model="feeCurrency" placeholder="e.g., USDT">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="ex-timestamp">Date <span class="required">*</span></label>
                            <input type="datetime-local" id="ex-timestamp" name="timestamp" class="form-control" required x-model="timestamp">
                        </div>
                        <div class="form-group">
                            <label for="ex-notes">Notes</label>
                            <textarea id="ex-notes" name="notes" class="form-control" rows="2" x-model="notes" placeholder="Optional notes..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" @click="open = false" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-primary" x-text="isEdit ? 'Update' : 'Add'"></button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div x-data="deleteExchangeModal()" @open-delete-exchange.window="openDelete($event.detail)" @keydown.escape.window="open = false">
        <div x-show="open" x-cloak class="modal-overlay" @click.self="open = false">
            <div class="modal modal-sm" x-transition>
                <div class="modal-header">
                    <h2 class="modal-title">Delete Exchange</h2>
                    <button @click="open = false" class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this exchange?</p>
                </div>
                <div class="modal-footer">
                    <button @click="open = false" class="btn btn-secondary">Cancel</button>
                    <button @click="confirmDelete()" class="btn btn-danger">Delete</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function exchangeModal() {
    return {
        open: false,
        isEdit: false,
        exchangeId: null,
        fromAssetId: '',
        fromAmount: '',
        toAssetId: '',
        toAmount: '',
        fee: '',
        feeCurrency: '',
        timestamp: '',
        notes: '',
        openAdd() {
            this.isEdit = false;
            this.exchangeId = null;
            this.fromAssetId = '';
            this.fromAmount = '';
            this.toAssetId = '';
            this.toAmount = '';
            this.fee = '';
            this.feeCurrency = '';
            this.timestamp = new Date().toISOString().slice(0, 16);
            this.notes = '';
            this.open = true;
        },
        openEdit(detail) {
            this.isEdit = true;
            this.exchangeId = detail.id;
            this.fromAssetId = detail.from_asset_id;
            this.fromAmount = detail.from_amount;
            this.toAssetId = detail.to_asset_id;
            this.toAmount = detail.to_amount;
            this.fee = detail.fee || '';
            this.feeCurrency = detail.fee_currency || '';
            this.timestamp = detail.timestamp;
            this.notes = detail.notes || '';
            this.open = true;
        }
    }
}

function deleteExchangeModal() {
    return {
        open: false,
        exchangeId: null,
        openDelete(detail) {
            this.exchangeId = detail.id;
            this.open = true;
        },
        confirmDelete() {
            htmx.ajax('DELETE', '/partials/exchanges/delete/' + this.exchangeId, {
                target: '#exchanges-table-container',
                swap: 'innerHTML'
            }).then(() => {
                this.open = false;
                window.dispatchEvent(new CustomEvent('show-toast', {
                    detail: { message: 'Exchange deleted', type: 'success' }
                }));
            });
        }
    }
}
</script>
{{end}}
