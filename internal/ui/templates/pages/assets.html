{{define "content"}}
<div class="assets-page">
    <section class="page-header">
        <div class="page-header-actions" x-data="{ syncing: false }">
            <button class="btn btn-secondary" @click="syncPrices()" :disabled="syncing">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" :class="{ 'spin': syncing }">
                    <path d="M21 12a9 9 0 11-9-9"/>
                    <path d="M21 3v6h-6"/>
                </svg>
                <span x-text="syncing ? 'Syncing...' : 'Sync Prices'"></span>
            </button>
            <button class="btn btn-primary" @click="$dispatch('open-add-asset')">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"/>
                </svg>
                Add Asset
            </button>
        </div>
    </section>

    <section class="assets-filters">
        <div class="card">
            <div class="card-body filters-row">
                <div class="filter-group">
                    <label>Symbol</label>
                    <select name="symbol" class="form-control"
                        hx-get="/partials/assets/table"
                        hx-target="#assets-table-container"
                        hx-include=".filters-row select, .filters-row input">
                        <option value="">All Symbols</option>
                        {{range .Symbols}}
                        <option value="{{.}}">{{.}}</option>
                        {{end}}
                    </select>
                </div>
                <div class="filter-group">
                    <label>Type</label>
                    <select name="type" class="form-control"
                        hx-get="/partials/assets/table"
                        hx-target="#assets-table-container"
                        hx-include=".filters-row select, .filters-row input">
                        <option value="">All Types</option>
                        <option value="deposit">Deposit</option>
                        <option value="withdraw">Withdraw</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>From</label>
                    <input type="date" name="from" class="form-control"
                        hx-get="/partials/assets/table"
                        hx-target="#assets-table-container"
                        hx-trigger="change"
                        hx-include=".filters-row select, .filters-row input">
                </div>
                <div class="filter-group">
                    <label>To</label>
                    <input type="date" name="to" class="form-control"
                        hx-get="/partials/assets/table"
                        hx-target="#assets-table-container"
                        hx-trigger="change"
                        hx-include=".filters-row select, .filters-row input">
                </div>
            </div>
        </div>
    </section>

    <section class="assets-data" x-data="{ view: 'transactions' }">
        <div class="card">
            <div class="card-header">
                <div class="card-header-tabs">
                    <button class="btn" :class="view === 'holdings' ? 'btn-primary' : 'btn-secondary'" @click="view = 'holdings'">
                        Holdings
                    </button>
                    <button class="btn" :class="view === 'transactions' ? 'btn-primary' : 'btn-secondary'" @click="view = 'transactions'">
                        Transactions
                    </button>
                </div>
            </div>
            <div class="card-body" x-data="assetSelection()">
                <div x-show="view === 'holdings'" x-cloak>
                    <div id="assets-holdings-container" hx-get="/partials/assets/holdings" hx-trigger="load" hx-swap="innerHTML">
                        <div class="skeleton-table">
                            <div class="skeleton-row"><div class="skeleton text"></div><div class="skeleton text"></div><div class="skeleton text"></div></div>
                            <div class="skeleton-row"><div class="skeleton text"></div><div class="skeleton text"></div><div class="skeleton text"></div></div>
                            <div class="skeleton-row"><div class="skeleton text"></div><div class="skeleton text"></div><div class="skeleton text"></div></div>
                        </div>
                    </div>
                </div>
                <div x-show="view === 'transactions'">
                    <div id="assets-table-container" hx-get="/partials/assets/table" hx-trigger="load" hx-swap="innerHTML" @htmx:after-swap="clearSelection()">
                        <div class="skeleton-table">
                            <div class="skeleton-row"><div class="skeleton text"></div><div class="skeleton text"></div><div class="skeleton text"></div><div class="skeleton text"></div></div>
                            <div class="skeleton-row"><div class="skeleton text"></div><div class="skeleton text"></div><div class="skeleton text"></div><div class="skeleton text"></div></div>
                            <div class="skeleton-row"><div class="skeleton text"></div><div class="skeleton text"></div><div class="skeleton text"></div><div class="skeleton text"></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div x-data="assetModal()" @open-add-asset.window="openAdd()" @open-edit-asset.window="openEdit($event.detail)" @close-modal.window="open = false" @crypto-selected="symbol = $event.detail.symbol; name = $event.detail.name; priceSource = $event.detail.source">
        <div x-show="open" x-cloak class="modal-overlay" @click.self="open = false" @keydown.escape.window="open = false">
            <div class="modal" x-transition>
                <div class="modal-header">
                    <h2 class="modal-title" x-text="isEdit ? 'Edit Asset' : 'Add Asset'"></h2>
                    <button @click="open = false" class="modal-close">&times;</button>
                </div>
                <form @submit.prevent="submitForm($el)"
                      hx-target="#assets-table-container"
                      hx-swap="innerHTML">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="asset-type">Type <span class="required">*</span></label>
                            <select id="asset-type" name="type" class="form-control" required x-model="type">
                                <option value="">Select type...</option>
                                <option value="deposit">Deposit</option>
                                <option value="withdraw">Withdraw</option>
                            </select>
                        </div>
                        <div class="form-group" x-data="cryptoSearch()" x-init="$watch('symbol', value => search = value)">
                            <label for="asset-symbol">Symbol <span class="required">*</span></label>
                            <div class="crypto-select" @click.outside="showDropdown = false">
                                <input type="text" id="asset-symbol" name="symbol" class="form-control" required
                                    x-model="search" placeholder="Search crypto..."
                                    @input="onInput($event.target.value); symbol = $event.target.value.toUpperCase()"
                                    @focus="onFocus()"
                                    @keydown.arrow-down.prevent="highlightNext()"
                                    @keydown.arrow-up.prevent="highlightPrev()"
                                    @keydown.enter.prevent="selectHighlighted()"
                                    @keydown.escape="showDropdown = false"
                                    autocomplete="off">
                                <input type="hidden" name="price_source" x-model="priceSource">
                                <div class="crypto-dropdown" x-show="showDropdown" x-cloak>
                                    <template x-for="(crypto, index) in filteredCryptos" :key="crypto.symbol">
                                        <div class="crypto-option"
                                            :class="{ 'highlighted': index === highlightedIndex }"
                                            @click="selectCrypto(crypto)"
                                            @mouseenter="highlightedIndex = index">
                                            <span class="crypto-symbol" x-text="crypto.symbol"></span>
                                            <span class="crypto-name" x-text="crypto.name"></span>
                                        </div>
                                    </template>
                                    <div class="crypto-option crypto-deep-search" @click="$dispatch('open-deep-search', { query: search })">
                                        <span class="deep-search-text">Can't find asset? Search deeper...</span>
                                    </div>
                                </div>
                            </div>
                            <small class="form-hint">Select from supported cryptocurrencies</small>
                        </div>
                        <div class="form-group">
                            <label for="asset-name">Name</label>
                            <input type="text" id="asset-name" name="name" class="form-control"
                                x-model="name" placeholder="Auto-filled from selection" readonly>
                            <small class="form-hint">Auto-filled from selection</small>
                        </div>
                        <div class="form-group">
                            <label for="asset-amount">Amount <span class="required">*</span></label>
                            <input type="number" id="asset-amount" name="amount" class="form-control"
                                step="any" min="0" required x-model="amount" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="asset-timestamp">Date <span class="required">*</span></label>
                            <input type="datetime-local" id="asset-timestamp" name="timestamp" class="form-control" required x-model="timestamp">
                        </div>
                        <div class="form-group">
                            <label for="asset-notes">Notes</label>
                            <textarea id="asset-notes" name="notes" class="form-control" rows="2" x-model="notes" placeholder="Optional notes..."
                                @keydown.ctrl.enter.prevent="submitForm($el.closest('form'))"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" @click="open = false" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-primary" x-text="isEdit ? 'Update' : 'Add'"></button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div x-data="deleteAssetModal()" @open-delete-asset.window="openDelete($event.detail)" @keydown.escape.window="open = false">
        <div x-show="open" x-cloak class="modal-overlay" @click.self="open = false">
            <div class="modal modal-sm" x-transition>
                <div class="modal-header">
                    <h2 class="modal-title">Delete Asset Entry</h2>
                    <button @click="open = false" class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this asset entry?</p>
                </div>
                <div class="modal-footer">
                    <button @click="open = false" class="btn btn-secondary">Cancel</button>
                    <button @click="confirmDelete()" class="btn btn-danger">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <div x-data="bulkDeleteAssetModal()" @open-bulk-delete-assets.window="openBulkDelete()" @keydown.escape.window="open = false">
        <div x-show="open" x-cloak class="modal-overlay" @click.self="open = false">
            <div class="modal modal-sm" x-transition>
                <div class="modal-header">
                    <h2 class="modal-title">Delete Selected Assets</h2>
                    <button @click="open = false" class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete <strong x-text="count"></strong> selected asset entries?</p>
                </div>
                <div class="modal-footer">
                    <button @click="open = false" class="btn btn-secondary">Cancel</button>
                    <button @click="confirmBulkDelete()" class="btn btn-danger">Delete All</button>
                </div>
            </div>
        </div>
    </div>

    <div x-data="deepSearchModal()" @open-deep-search.window="openSearch($event.detail)" @keydown.escape.window="open = false">
        <div x-show="open" x-cloak class="modal-overlay" @click.self="open = false">
            <div class="modal" x-transition style="max-width: 620px;">
                <div class="modal-header">
                    <h2 class="modal-title">Deep Search</h2>
                    <button @click="open = false" class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="deep-search-tabs" style="display: flex; gap: 8px; margin-bottom: 16px;">
                        <button type="button" class="tab-btn" :class="{ 'active': activeTab === 'search' }" @click="activeTab = 'search'"
                            :style="activeTab === 'search' ? 'flex:1; padding:10px 16px; background:#f7931a; border:1px solid #f7931a; color:#0d1117; cursor:pointer; border-radius:6px; font-weight:500;' : 'flex:1; padding:10px 16px; background:transparent; border:1px solid #f7931a; color:#f7931a; cursor:pointer; border-radius:6px; font-weight:500;'">Search</button>
                        <button type="button" class="tab-btn" :class="{ 'active': activeTab === 'link' }" @click="activeTab = 'link'"
                            :style="activeTab === 'link' ? 'flex:1; padding:10px 16px; background:#f7931a; border:1px solid #f7931a; color:#0d1117; cursor:pointer; border-radius:6px; font-weight:500;' : 'flex:1; padding:10px 16px; background:transparent; border:1px solid #f7931a; color:#f7931a; cursor:pointer; border-radius:6px; font-weight:500;'">Paste Link</button>
                    </div>

                    <div x-show="activeTab === 'search'">
                        <div class="form-group">
                            <input type="text" class="form-control" x-model="query" placeholder="Symbol (e.g., HYPE)"
                                @keydown.enter.prevent="search()">
                        </div>
                        <div class="form-group">
                            <input type="text" class="form-control" x-model="nameQuery" placeholder="Name (e.g., hyperliquid) - optional"
                                @keydown.enter.prevent="search()">
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn btn-primary" @click="search()" :disabled="loading" style="width: 100%;">
                                <span x-show="!loading">Search</span>
                                <span x-show="loading">Searching...</span>
                            </button>
                        </div>
                        <div class="form-group">
                            <div class="provider-toggle" @click="showProviders = !showProviders">
                                <span>Providers</span>
                                <svg :class="{ 'rotated': showProviders }" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M6 9l6 6 6-6"/>
                                </svg>
                            </div>
                            <div x-show="showProviders" x-collapse class="provider-list">
                                <template x-for="provider in availableProviders" :key="provider">
                                    <label class="provider-checkbox">
                                        <input type="checkbox" :value="provider" x-model="selectedProviders">
                                        <span x-text="formatProviderName(provider)"></span>
                                    </label>
                                </template>
                            </div>
                        </div>
                    </div>

                    <div x-show="activeTab === 'link'">
                        <div class="form-group">
                            <input type="text" class="form-control" x-model="linkInput" placeholder="e.g., https://www.coingecko.com/en/coins/hyperliquid"
                                @input="parseLink()" @keydown.enter.prevent="fetchFromLink()">
                        </div>
                        <div class="form-group" x-show="parsedLink.provider">
                            <div class="parsed-link-info">
                                <span class="parsed-provider" x-text="formatProviderName(parsedLink.provider)"></span>
                                <span class="parsed-asset" x-text="parsedLink.asset"></span>
                            </div>
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn btn-primary" @click="fetchFromLink()" :disabled="loading || !parsedLink.provider" style="width: 100%;">
                                <span x-show="!loading">Fetch Price</span>
                                <span x-show="loading">Fetching...</span>
                            </button>
                        </div>
                        <div class="form-group">
                            <p class="supported-links-label">Supported link formats:</p>
                            <ul class="supported-links">
                                <li>coingecko.com/en/coins/<em>asset-name</em></li>
                                <li>defillama.com/protocol/<em>asset-name</em></li>
                                <li>geckoterminal.com/.../pools/<em>address</em></li>
                                <li>binance.com/en/price/<em>symbol</em></li>
                                <li>kraken.com/prices/<em>symbol</em></li>
                            </ul>
                        </div>
                        <div class="link-error" x-show="linkError" x-text="linkError"></div>
                    </div>

                    <div class="deep-search-results" x-show="results.length > 0 || searched">
                        <template x-if="results.length === 0 && searched && !loading">
                            <p class="no-results">No results found. Try a different search term.</p>
                        </template>
                        <div x-show="results.length > 0" style="display:flex; flex-direction:column; gap:8px;">
                            <div style="display:flex; padding:8px 0; border-bottom:1px solid #30363d; font-size:12px; color:#8b949e;">
                                <span style="flex:0 0 60px;">Symbol</span>
                                <span style="flex:1;">Name</span>
                                <span style="flex:0 0 90px;">Price</span>
                                <span style="flex:0 0 110px;">Provider</span>
                                <span style="flex:0 0 180px;"></span>
                            </div>
                            <template x-for="result in results" :key="result.symbol + result.source">
                                <div style="display:flex; align-items:center; padding:8px 0; border-bottom:1px solid #30363d;">
                                    <span style="flex:0 0 60px; font-weight:500;" x-text="result.symbol"></span>
                                    <span style="flex:1; color:#8b949e;" x-text="result.name"></span>
                                    <span style="flex:0 0 90px;" x-text="'$' + result.price.toFixed(result.price < 1 ? 6 : 2)"></span>
                                    <span style="flex:0 0 110px; color:#8b949e;" x-text="formatProviderName(result.source)"></span>
                                    <span style="flex:0 0 180px; display:flex; gap:8px; justify-content:flex-end;">
                                        <a :href="getProviderLink(result)" target="_blank" rel="noopener noreferrer" @click.stop
                                            style="display:inline-block; padding:6px 12px; font-size:12px; background:#f7931a; color:#0d1117; border:none; font-weight:500; border-radius:6px; cursor:pointer; text-decoration:none;">Check Source</a>
                                        <button type="button" @click="selectResult(result)"
                                            style="padding:6px 12px; font-size:12px; background:#f7931a; color:#0d1117; border:none; font-weight:500; border-radius:6px; cursor:pointer;">Select</button>
                                    </span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" @click="open = false" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let cachedCryptos = null;
let selectedAssetsStore = [];

async function syncPrices() {
    const btn = event.currentTarget;
    const svg = btn.querySelector('svg');
    btn.disabled = true;
    svg.classList.add('spin');
    try {
        const response = await fetch('/api/prices/sync', { method: 'POST' });
        if (response.ok) {
            htmx.trigger('#assets-table-container', 'htmx:load');
            window.dispatchEvent(new CustomEvent('show-toast', {
                detail: { message: 'Prices synced successfully', type: 'success' }
            }));
        } else {
            window.dispatchEvent(new CustomEvent('show-toast', {
                detail: { message: 'Failed to sync prices', type: 'error' }
            }));
        }
    } catch (e) {
        console.error('Sync failed:', e);
        window.dispatchEvent(new CustomEvent('show-toast', {
            detail: { message: 'Failed to sync prices', type: 'error' }
        }));
    } finally {
        btn.disabled = false;
        svg.classList.remove('spin');
    }
}

function assetSelection() {
    return {
        selectedAssets: selectedAssetsStore,
        get allAssetsSelected() {
            const checkboxes = document.querySelectorAll('#assets-table-container .row-checkbox');
            return checkboxes.length > 0 && this.selectedAssets.length === checkboxes.length;
        },
        toggleAsset(id, checked) {
            if (checked) {
                if (!this.selectedAssets.includes(id)) {
                    this.selectedAssets.push(id);
                }
            } else {
                this.selectedAssets = this.selectedAssets.filter(i => i !== id);
            }
            selectedAssetsStore = this.selectedAssets;
        },
        toggleAllAssets(checked) {
            const checkboxes = document.querySelectorAll('#assets-table-container .row-checkbox');
            if (checked) {
                this.selectedAssets = Array.from(checkboxes).map(cb => parseInt(cb.value));
            } else {
                this.selectedAssets = [];
            }
            selectedAssetsStore = this.selectedAssets;
        },
        clearSelection() {
            this.selectedAssets = [];
            selectedAssetsStore = [];
        }
    }
}

function bulkDeleteAssetModal() {
    return {
        open: false,
        count: 0,
        openBulkDelete() {
            this.count = selectedAssetsStore.length;
            if (this.count > 0) {
                this.open = true;
            }
        },
        confirmBulkDelete() {
            fetch('/partials/assets/bulk-delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids: selectedAssetsStore })
            }).then(response => {
                this.open = false;
                selectedAssetsStore = [];
                htmx.trigger('#assets-table-container', 'htmx:load');
                return response.text();
            }).then(html => {
                document.getElementById('assets-table-container').innerHTML = html;
            });
        }
    }
}

async function fetchCryptos() {
    if (cachedCryptos) return cachedCryptos;
    try {
        const response = await fetch('/api/ui/cryptos');
        cachedCryptos = await response.json();
        return cachedCryptos;
    } catch (e) {
        console.error('Failed to fetch cryptos:', e);
        return [];
    }
}

function cryptoSearch() {
    return {
        search: '',
        cryptos: [],
        filteredCryptos: [],
        showDropdown: false,
        highlightedIndex: 0,
        priceSource: '',
        async init() {
            this.cryptos = await fetchCryptos();
            window.addEventListener('deep-search-selected', (e) => {
                this.selectCrypto({ symbol: e.detail.symbol, name: e.detail.name }, e.detail.source);
            });
        },
        onFocus() {
            this.filterCryptos();
            this.showDropdown = true;
            this.highlightedIndex = 0;
        },
        onInput(value) {
            this.search = value.toUpperCase();
            this.priceSource = '';
            this.filterCryptos();
            this.highlightedIndex = 0;
        },
        filterCryptos() {
            if (!this.search) {
                this.filteredCryptos = this.cryptos.slice(0, 10);
                return;
            }
            const term = this.search.toLowerCase();
            this.filteredCryptos = this.cryptos
                .filter(c => c.symbol.toLowerCase().includes(term) || c.name.toLowerCase().includes(term))
                .slice(0, 10);
        },
        selectCrypto(crypto, source = '') {
            this.search = crypto.symbol;
            this.priceSource = source;
            this.showDropdown = false;
            this.$dispatch('crypto-selected', { symbol: crypto.symbol, name: crypto.name, source: source });
            this.$nextTick(() => {
                document.getElementById('asset-amount').focus();
            });
        },
        highlightNext() {
            if (this.highlightedIndex < this.filteredCryptos.length - 1) {
                this.highlightedIndex++;
            }
        },
        highlightPrev() {
            if (this.highlightedIndex > 0) {
                this.highlightedIndex--;
            }
        },
        selectHighlighted() {
            if (this.filteredCryptos.length > 0) {
                this.selectCrypto(this.filteredCryptos[this.highlightedIndex]);
            }
        }
    }
}

function assetModal() {
    return {
        open: false,
        isEdit: false,
        assetEntryId: null,
        type: '',
        symbol: '',
        name: '',
        amount: '',
        timestamp: '',
        notes: '',
        priceSource: '',
        openAdd() {
            this.isEdit = false;
            this.assetEntryId = null;
            this.type = '';
            this.symbol = '';
            this.name = '';
            this.amount = '';
            this.timestamp = new Date().toISOString().slice(0, 16);
            this.notes = '';
            this.priceSource = '';
            this.open = true;
        },
        openEdit(detail) {
            this.isEdit = true;
            this.assetEntryId = detail.id;
            this.type = detail.type;
            this.symbol = detail.symbol;
            this.name = detail.name || '';
            this.amount = detail.amount;
            this.timestamp = detail.timestamp;
            this.notes = detail.notes || '';
            this.priceSource = detail.priceSource || '';
            this.open = true;
        },
        submitForm(form) {
            const url = this.isEdit
                ? '/partials/assets/update/' + this.assetEntryId
                : '/partials/assets/create';
            const self = this;
            const priceSourceInput = form.querySelector('input[name="price_source"]');
            const priceSource = priceSourceInput ? priceSourceInput.value : '';
            htmx.ajax('POST', url, {
                target: '#assets-table-container',
                swap: 'innerHTML',
                values: {
                    type: this.type,
                    symbol: this.symbol,
                    name: this.name,
                    amount: this.amount,
                    timestamp: this.timestamp,
                    notes: this.notes,
                    price_source: priceSource
                }
            }).then(() => {
                self.open = false;
                window.dispatchEvent(new CustomEvent('show-toast', {
                    detail: { message: self.isEdit ? 'Asset updated' : 'Asset added', type: 'success' }
                }));
            });
        }
    }
}

function deleteAssetModal() {
    return {
        open: false,
        assetEntryId: null,
        openDelete(detail) {
            this.assetEntryId = detail.id;
            this.open = true;
        },
        confirmDelete() {
            htmx.ajax('DELETE', '/partials/assets/delete/' + this.assetEntryId, {
                target: '#assets-table-container',
                swap: 'innerHTML'
            }).then(() => {
                this.open = false;
                window.dispatchEvent(new CustomEvent('show-toast', {
                    detail: { message: 'Asset entry deleted', type: 'success' }
                }));
            });
        }
    }
}

function deepSearchModal() {
    return {
        open: false,
        activeTab: 'search',
        query: '',
        nameQuery: '',
        loading: false,
        searched: false,
        results: [],
        availableProviders: [],
        selectedProviders: [],
        showProviders: false,
        linkInput: '',
        parsedLink: { provider: '', asset: '', network: '' },
        linkError: '',
        async openSearch(detail) {
            this.query = detail?.query || '';
            this.nameQuery = '';
            this.results = [];
            this.searched = false;
            this.loading = false;
            this.activeTab = 'search';
            this.linkInput = '';
            this.parsedLink = { provider: '', asset: '', network: '' };
            this.linkError = '';
            this.open = true;
            if (this.availableProviders.length === 0) {
                await this.fetchProviders();
            }
        },
        async fetchProviders() {
            try {
                const response = await fetch('/api/prices/deep-search/providers');
                this.availableProviders = await response.json();
                this.selectedProviders = [...this.availableProviders];
            } catch (e) {
                console.error('Failed to fetch providers:', e);
            }
        },
        parseLink() {
            this.linkError = '';
            this.parsedLink = { provider: '', asset: '', network: '' };
            const url = this.linkInput.trim();
            if (!url) return;

            try {
                const patterns = [
                    { regex: /coingecko\.com\/(?:en\/)?coins\/([^/?#]+)/i, provider: 'coingecko', type: 'name' },
                    { regex: /defillama\.com\/protocol\/([^/?#]+)/i, provider: 'defillama', type: 'name' },
                    { regex: /geckoterminal\.com\/([^/]+)\/pools\/([^/?#]+)/i, provider: 'geckoterminal', type: 'address' },
                    { regex: /binance\.com\/(?:en\/)?price\/([^/?#]+)/i, provider: 'binance', type: 'symbol' },
                    { regex: /kraken\.com\/prices\/([^/?#]+)/i, provider: 'kraken', type: 'symbol' },
                ];

                for (const pattern of patterns) {
                    const match = url.match(pattern.regex);
                    if (match) {
                        if (pattern.provider === 'geckoterminal') {
                            this.parsedLink = { provider: pattern.provider, asset: match[2], network: match[1] };
                        } else {
                            this.parsedLink = { provider: pattern.provider, asset: match[1], network: '' };
                        }
                        return;
                    }
                }
            } catch (e) {
                console.error('Failed to parse link:', e);
            }
        },
        async fetchFromLink() {
            if (!this.parsedLink.provider || !this.parsedLink.asset) return;
            this.loading = true;
            this.searched = true;
            this.linkError = '';
            try {
                const params = new URLSearchParams({
                    q: this.parsedLink.asset.toUpperCase(),
                    name: this.parsedLink.asset,
                    providers: this.parsedLink.provider
                });
                if (this.parsedLink.network) {
                    params.append('network', this.parsedLink.network);
                }
                const response = await fetch('/api/prices/deep-search?' + params.toString());
                this.results = await response.json();
                if (this.results.length === 0) {
                    this.linkError = 'Could not fetch price for this asset';
                }
            } catch (e) {
                console.error('Fetch from link failed:', e);
                this.results = [];
                this.linkError = 'Failed to fetch price';
            } finally {
                this.loading = false;
            }
        },
        async search() {
            if (!this.query.trim()) return;
            this.loading = true;
            this.searched = true;
            try {
                const params = new URLSearchParams({ q: this.query });
                if (this.nameQuery.trim()) {
                    params.append('name', this.nameQuery.trim());
                }
                if (this.selectedProviders.length > 0 && this.selectedProviders.length < this.availableProviders.length) {
                    params.append('providers', this.selectedProviders.join(','));
                }
                const response = await fetch('/api/prices/deep-search?' + params.toString());
                this.results = await response.json();
            } catch (e) {
                console.error('Deep search failed:', e);
                this.results = [];
            } finally {
                this.loading = false;
            }
        },
        formatProviderName(provider) {
            const names = {
                'kraken': 'Kraken',
                'binance': 'Binance',
                'coingecko': 'CoinGecko',
                'defillama': 'DefiLlama',
                'geckoterminal': 'GeckoTerminal'
            };
            return names[provider] || provider;
        },
        getProviderLink(result) {
            const symbol = result.symbol.toLowerCase();
            const name = (result.name || symbol).toLowerCase().replace(/\s+/g, '-');
            switch (result.source) {
                case 'kraken':
                    return `https://www.kraken.com/prices/${symbol}`;
                case 'binance':
                    return `https://www.binance.com/en/price/${symbol}`;
                case 'coingecko':
                    return `https://www.coingecko.com/en/coins/${name}`;
                case 'defillama':
                    if (result.pool_address && result.network) {
                        return `https://defillama.com/${result.network}/token/${result.pool_address}`;
                    }
                    return `https://defillama.com/protocol/${name}`;
                case 'geckoterminal':
                    if (result.pool_address && result.network) {
                        return `https://www.geckoterminal.com/${result.network}/pools/${result.pool_address}`;
                    }
                    return `https://www.geckoterminal.com/search?query=${symbol}`;
                default:
                    return '#';
            }
        },
        selectResult(result) {
            window.dispatchEvent(new CustomEvent('deep-search-selected', {
                detail: {
                    symbol: result.symbol,
                    name: result.name,
                    source: result.source
                }
            }));
            this.open = false;
        }
    }
}
</script>
{{end}}
