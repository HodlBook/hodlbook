{{define "content"}}
<div class="prices-page" x-data="pricesPage()">
    <section class="page-header">
        <div class="page-header-actions">
            <button class="btn btn-secondary" @click="refreshPrices()" :disabled="refreshing">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" :class="refreshing && 'spin'">
                    <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/>
                    <path d="M21 3v5h-5"/>
                </svg>
                <span x-text="refreshing ? 'Refreshing...' : 'Refresh'"></span>
            </button>
            <div class="sse-status" :class="connected ? 'connected' : 'disconnected'">
                <span class="status-indicator"></span>
                <span x-text="connected ? 'Connected' : 'Disconnected'"></span>
            </div>
        </div>
    </section>

    <section class="prices-grid">
        <div id="prices-table-container" hx-get="/partials/prices/table" hx-trigger="load" hx-swap="innerHTML">
            <div class="skeleton-grid">
                <div class="skeleton-card"><div class="skeleton text lg"></div><div class="skeleton text"></div></div>
                <div class="skeleton-card"><div class="skeleton text lg"></div><div class="skeleton text"></div></div>
                <div class="skeleton-card"><div class="skeleton text lg"></div><div class="skeleton text"></div></div>
                <div class="skeleton-card"><div class="skeleton text lg"></div><div class="skeleton text"></div></div>
            </div>
        </div>
    </section>
</div>

<script>
function pricesPage() {
    return {
        connected: false,
        refreshing: false,
        prices: {},
        init() {
            this.connectSSE();
        },
        async refreshPrices() {
            this.refreshing = true;
            try {
                await htmx.ajax('GET', '/partials/prices/table', { target: '#prices-table-container', swap: 'innerHTML' });
            } finally {
                this.refreshing = false;
            }
        },
        connectSSE() {
            const eventSource = new EventSource('/api/prices/stream');

            eventSource.onopen = () => {
                this.connected = true;
            };

            eventSource.addEventListener('prices', (event) => {
                try {
                    const data = JSON.parse(event.data);
                    this.updatePrices(data);
                } catch (e) {
                    console.error('Failed to parse price data:', e);
                }
            });

            eventSource.onerror = () => {
                this.connected = false;
                eventSource.close();
                setTimeout(() => this.connectSSE(), 5000);
            };
        },
        updatePrices(data) {
            for (const [symbol, price] of Object.entries(data)) {
                const priceEl = document.querySelector(`[data-price-symbol="${symbol}"]`);
                if (priceEl) {
                    const oldPrice = parseFloat(priceEl.dataset.priceValue) || 0;
                    const newPrice = parseFloat(price);

                    priceEl.dataset.priceValue = newPrice;
                    priceEl.textContent = this.formatCurrency(newPrice);

                    priceEl.classList.remove('price-up', 'price-down');
                    if (newPrice > oldPrice) {
                        priceEl.classList.add('price-up');
                    } else if (newPrice < oldPrice) {
                        priceEl.classList.add('price-down');
                    }

                    setTimeout(() => {
                        priceEl.classList.remove('price-up', 'price-down');
                    }, 1000);
                }
            }
        },
        formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: value < 1 ? 6 : 2
            }).format(value);
        }
    }
}
</script>
{{end}}
