#!/bin/bash

LOG_FILE="${HOME}/.tmp/hodlbook.log"
mkdir -p "${HOME}/.tmp"

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "${LOG_FILE}"
}

log "HodlBook post-install: Starting"
log "APP_DATA_DIR=${APP_DATA_DIR}"

DATA_DIR="${APP_DATA_DIR}/data"

# Check if directory exists but has wrong ownership
if [ -d "${DATA_DIR}" ]; then
    OWNER=$(stat -c '%u:%g' "${DATA_DIR}" 2>/dev/null)
    log "Existing data directory found with owner ${OWNER}"
    if [ "${OWNER}" != "1000:1000" ]; then
        log "Fixing ownership from ${OWNER} to 1000:1000"
        chown -R 1000:1000 "${DATA_DIR}" 2>/dev/null || log "WARNING: Could not fix ownership"
    fi
else
    log "Creating data directory at ${DATA_DIR}"
    mkdir -p "${DATA_DIR}" || {
        log "ERROR: Failed to create directory ${DATA_DIR}"
        exit 1
    }
    log "Directory created, setting ownership"
    chown 1000:1000 "${DATA_DIR}" 2>/dev/null || log "WARNING: Could not chown ${DATA_DIR}"
fi

# Ensure directory is writable by testing
TEST_FILE="${DATA_DIR}/.write_test"
if touch "${TEST_FILE}" 2>/dev/null; then
    rm -f "${TEST_FILE}"
    log "Directory is writable"
else
    log "ERROR: Directory ${DATA_DIR} is not writable, attempting fix"
    chmod 755 "${DATA_DIR}" 2>/dev/null
    chown 1000:1000 "${DATA_DIR}" 2>/dev/null
fi

log "Data directory ready: $(ls -la ${DATA_DIR} 2>&1)"
log "Parent directory permissions: $(ls -la ${APP_DATA_DIR} 2>&1 | grep data)"
log "HodlBook post-install: Complete"
